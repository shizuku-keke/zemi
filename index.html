<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ã‚¼ãƒŸã®åœ°å›³ï¼ˆæ±ºå®šç‰ˆï¼‰</title>
  <link rel="stylesheet" href="leaflet/leaflet.css" />
  <style>
    /* === 1. å…¨ä½“ãƒ»åŸºæœ¬ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ (å¤‰æ›´ãªã—) === */
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: sans-serif;
    }

    body {
      display: flex;
      overflow: hidden;
    }

    #map-container {
      position: relative;
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
    }

    #map {
      flex: 1;
    }

    /* === 2. ã‚µã‚¤ãƒ‰ãƒãƒ¼é–¢é€£ (å¤‰æ›´ãªã—) === */
    #sidebar {
      width: 300px;
      flex-shrink: 0;
      background: #f8f8f8;
      padding: 15px;
      overflow-y: auto;
      border-right: 1px solid #ccc;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      transition: margin-left 0.3s ease-in-out;
    }

    body.sidebar-collapsed #sidebar {
      margin-left: -300px;
    }

    #sidebar h2 {
      margin-top: 0;
      font-size: 20px;
    }
    
    #search-input { width: 100%; padding: 8px; margin-bottom: 10px; box-sizing: border-box; font-size: 14px; }
    #place-list { flex-grow: 1; overflow-y: auto; }
    .place-card { margin-bottom: 20px; padding: 10px; border: 1px solid #ddd; background-color: white; border-radius: 8px; cursor: pointer; transition: background-color 0.3s, box-shadow 0.3s; }
    .place-card:hover { background-color: #f5f5f5; }
    .place-card.highlight { background-color: #fffbe6 !important; border: 2px solid #ffec3d !important; box-shadow: 0 0 10px 2px #ffe58f !important; }
    .place-card img { width: 100%; height: 150px; object-fit: cover; border-radius: 4px; }
    .place-tags { margin-top: 10px; }
    .place-tags .tag { display: inline-block; background-color: #f0f0f0; color: #333; padding: 2px 6px; margin: 2px; border-radius: 4px; font-size: 12px; }
    #sidebar-toggle { position: absolute; top: 50%; transform: translateY(-50%); left: 0; width: 25px; height: 48px; background-color: white; border: 1px solid #ccc; border-left: none; border-radius: 0 4px 4px 0; cursor: pointer; z-index: 1001; display: flex; align-items: center; justify-content: center; box-shadow: 2px 0 5px rgba(0,0,0,0.1); }
    #sidebar-toggle-icon { width: 8px; height: 8px; border-style: solid; border-color: #666; border-width: 0 2px 2px 0; transform: rotate(135deg); transition: transform 0.3s ease-in-out; }
    body.sidebar-collapsed #sidebar-toggle-icon { transform: rotate(-45deg); }
    
    /* === 3. ä¸Šéƒ¨ãƒœã‚¿ãƒ³ãƒ»ã‚¿ã‚°ã‚¨ãƒªã‚¢ === */
    #buttons { background: #eee; padding: 10px; display: flex; flex-direction: column; gap: 10px; flex-shrink: 0; }
    #mode-switch-buttons { display: flex; justify-content: space-between; align-items: center; }
    #mode-switch-buttons button { padding: 6px 12px; cursor: pointer; user-select: none; border: 1px solid #ccc; background-color: white; border-radius: 4px; transition: all 0.3s; }
    #mode-switch-buttons > div button.active { background-color: #8bc34a; color: white; border-color: #7cb342; }

    /* â˜…â˜…â˜… é¢ç™½ãƒãƒƒãƒ—ãƒœã‚¿ãƒ³ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’è¿½åŠ  â˜…â˜…â˜… */
    #unique-mode-btn.active { background-color: #ff9800; color: white; border-color: #fb8c00; }
    
    #clear-all-btn { padding: 6px 12px; font-size: 13px; background-color: #f0f0f0; color: #333; }
    #clear-all-btn:hover:not(:disabled) { background-color: #e0e0e0; }
    #clear-all-btn:disabled { background-color: #f9f9f9; color: #bbb; cursor: not-allowed; border-color: #ddd; }
    
    /* é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã®ã‚¿ã‚° */
    #tsujou-tags { display: flex; overflow-x: auto; white-space: nowrap; gap: 10px; padding-bottom: 5px; }
    #tsujou-tags .tag-btn { flex-shrink: 0; padding: 5px 10px; border: 2px solid #ccc; background-color: white; border-radius: 4px; cursor: pointer; }
    #tsujou-tags .tag-btn.active { background-color: #8bc34a; color: white; }
    
    /* â˜…â˜…â˜… é¢ç™½ãƒãƒƒãƒ—ç”¨ã®ã‚¿ã‚°ã‚¹ã‚¿ã‚¤ãƒ«ã‚’è¿½åŠ  â˜…â˜…â˜… */
    #unique-tags { display: flex; overflow-x: auto; white-space: nowrap; gap: 10px; padding-bottom: 5px; }
    #unique-tags .tag-btn { flex-shrink: 0; padding: 5px 10px; border: 2px solid #ccc; background-color: white; border-radius: 4px; cursor: pointer; }
    #unique-tags .tag-btn.active { background-color: #ff9800; color: white; border-color: #fb8c00; }

    /* ç½å®³ãƒ¢ãƒ¼ãƒ‰ã®ã‚¿ã‚° */
    #disaster-tags { display: flex; flex-direction: column; gap: 5px; }
    #disaster-categories { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px; }
    .disaster-category-btn { position: relative; flex-shrink: 0; padding: 5px 25px 5px 10px; border-width: 2px; border-style: solid; background-color: white; border-radius: 4px; cursor: pointer; user-select: none; transition: background-color 0.3s, border-color 0.3s; }
    .disaster-category-btn::after { content: 'â–¼'; position: absolute; right: 8px; top: 50%; transform: translateY(-50%) scale(0.8); transition: transform 0.3s ease-out; color: #888; }
    .disaster-category-btn.is-open::after { transform: translateY(-50%) scale(0.8) rotate(180deg); }
    .disaster-category-btn.contains-selection { background-color: #fffbe6; border-color: #ffd54f; }
    #disaster-sub-tags { background-color: #f0f0f0; border-radius: 4px; padding: 0 10px; display: flex; gap: 8px; max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out, padding 0.3s ease-out; white-space: nowrap; }
    #disaster-sub-tags.show { max-height: 60px; overflow-x: auto; padding: 10px; padding-bottom: 15px; }
    .sub-tag-btn { padding: 4px 8px; border: 1px solid #ccc; background-color: white; border-radius: 15px; cursor: pointer; font-size: 13px; transition: background-color 0.2s; }
    .sub-tag-btn.active { background-color: #8bc34a; color: white; border-color: #7cb342; }
    .type-hinan { border-color: #f44336; }
    .type-shienn { border-color: #2196f3; }
    .type-mfd { border-color: #4caf50; }
    .type-of { border-color: #ff9800; }

    /* å„ç¨®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ */
    #tsujou-tags::-webkit-scrollbar, #unique-tags::-webkit-scrollbar, #disaster-categories::-webkit-scrollbar, #disaster-sub-tags::-webkit-scrollbar { height: 5px; }
    #tsujou-tags::-webkit-scrollbar-thumb, #unique-tags::-webkit-scrollbar-thumb, #disaster-categories::-webkit-scrollbar-thumb, #disaster-sub-tags::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }
    
    /* === 4. Leafletã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ« === */
    .custom-popup .leaflet-popup-content-wrapper { background: #ffffff; color: #4a4a4a; border-radius: 8px; box-shadow: 0 3px 14px rgba(0,0,0,0.4); display: inline-block; padding: 0; }
    .custom-popup .leaflet-popup-content { margin: 0; padding: 5px 10px; font-size: 10.5px; font-weight: bold; text-align: center; white-space: nowrap; }
    .custom-popup .leaflet-popup-tip { background: #ffffff; }

    /* â˜…â˜…â˜… çµµæ–‡å­—ãƒãƒ¼ã‚«ãƒ¼ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’è¿½åŠ  â˜…â˜…â˜… */
    .emoji-marker {
        font-size: 28px;
        text-align: center;
        line-height: 40px;
        background: rgba(255, 255, 255, 0.85);
        border: 2px solid #555;
        border-radius: 50%;
        box-shadow: 0 2px 5px rgba(0,0,0,0.4);
        font-family: "Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol"; /* çµµæ–‡å­—ã®è¡¨ç¤ºã‚’å®‰å®šã•ã›ã‚‹ */
    }

    /* === 5. ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ (å¤‰æ›´ãªã—) === */
    @media (max-width: 768px) {
      body { flex-direction: column; overflow: auto; }
      #map-container { width: 100%; height: 55vh; order: 1; }
      #sidebar { width: 100%; height: 45vh; order: 2; border-right: none; border-top: 2px solid #ccc; margin-left: 0 !important; }
      #sidebar-toggle { display: none; }
    }
  </style>
</head>
<body>

  <!-- === HTMLæ§‹é€ ï¼ˆé¢ç™½ãƒãƒƒãƒ—ã‚’å¸¸è¨­ï¼‰ === -->
  <div id="sidebar">
    <h2>ã¾ã£ã·ï½</h2>
    <h2>æ–½è¨­æƒ…å ±</h2>
    <input type="text" id="search-input" placeholder="æ–½è¨­åã‚„ã‚¿ã‚°ã§æ¤œç´¢" />
    <div id="place-list"></div>
  </div>

  <div id="map-container">
    <button id="sidebar-toggle" aria-label="ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’é–‹é–‰">
      <div id="sidebar-toggle-icon"></div>
    </button>
    <div id="buttons">
      <div id="mode-switch-buttons">
        <div>
          <button id="tsujou-mode-btn">é€šå¸¸ãƒ¢ãƒ¼ãƒ‰</button>
          <button id="disaster-mode-btn">ç½å®³ãƒ¢ãƒ¼ãƒ‰</button>
          <!-- â˜…â˜…â˜… é¢ç™½ãƒãƒƒãƒ—ãƒœã‚¿ãƒ³ã‚’å¸¸æ™‚è¡¨ç¤º â˜…â˜…â˜… -->
          <button id="unique-mode-btn">é¢ç™½ãƒãƒƒãƒ—</button>
        </div>
        <button id="clear-all-btn">é¸æŠã‚’ã™ã¹ã¦è§£é™¤</button>
      </div>
      <div id="tags-container">
        <div id="disaster-tags" style="display:none;">
          <div id="disaster-categories">
            <button class="disaster-category-btn type-hinan" data-group="hinan">é¿é›£é–¢é€£</button>
            <button class="disaster-category-btn type-shienn" data-group="shienn">æ”¯çµ¦é–¢é€£</button>
            <button class="disaster-category-btn type-mfd" data-group="mfd">æ•‘æ´é–¢é€£</button>
            <button class="disaster-category-btn type-of" data-group="of">ç”Ÿæ´»é–¢é€£</button>
          </div>
          <div id="disaster-sub-tags"></div>
        </div>
        <div id="tsujou-tags" style="display: none;">
          <button class="tag-btn" data-type="é£²é£Ÿåº—">ğŸ½ é£²é£Ÿåº—</button>
          <button class="tag-btn" data-type="å…¬åœ’">å…¬åœ’</button>
          <button class="tag-btn" data-type="ã‚¹ãƒ¼ãƒ‘ãƒ¼">ã‚¹ãƒ¼ãƒ‘ãƒ¼</button>
          <button class="tag-btn" data-type="ã‚­ãƒ£ãƒ—ãƒ†ãƒ³ç¿¼">ã‚­ãƒ£ãƒ—ãƒ†ãƒ³ç¿¼</button>
          <button class="tag-btn" data-type="åŒºç«‹æ–½è¨­">åŒºç«‹æ–½è¨­</button>
          <button class="tag-btn" data-type="ãã®ä»–">ãã®ä»–</button>
        </div>
        <!-- â˜…â˜…â˜… é¢ç™½ãƒãƒƒãƒ—ç”¨ã®ã‚¿ã‚°ã‚¨ãƒªã‚¢ã‚’å¸¸æ™‚è¡¨ç¤º â˜…â˜…â˜… -->
        <div id="unique-tags" style="display: none;">
          <button class="tag-btn" data-type="çŒ«">ğŸ± çŒ«</button>
          <button class="tag-btn" data-type="çœ‹æ¿">ğŸ“œ çœ‹æ¿</button>
          <button class="tag-btn" data-type="è‡ªè²©æ©Ÿ">ğŸ¥« è‡ªè²©æ©Ÿ</button>
          <button class="tag-btn" data-type="æ™¯è‰²">ğŸï¸ æ™¯è‰²</button>
          <button class="tag-btn" data-type="ãŠèŠ±">ğŸŒ¸ ãŠèŠ±</button>
        </div>
      </div>
    </div>
    <div id="map"></div>
  </div>
  
  <script src="leaflet/leaflet.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', () => {

      // --- 1. å®šæ•°å®šç¾© (DOMè¦ç´ ã€ãƒ‡ãƒ¼ã‚¿ãªã©) ---
      const map = L.map('map', { minZoom: 15 });
      const yotsugiBounds = [[35.7300, 139.8300], [35.7450, 139.8550]];

      // â˜…â˜…â˜… é¢ç™½ãƒãƒƒãƒ—ç”¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’å¾©æ´» â˜…â˜…â˜…
      const uniquePlaces = [
        { name: "å…¬åœ’ãƒ™ãƒ³ãƒã®ä¸»ã€ãƒœã‚¹", latlng: [35.73375, 139.83625], tags: ["çŒ«"], icon: "çŒ«", image: "images/marker_cat.png", description: "èŒ¶ãƒˆãƒ©æŸ„ã€‚å¤•æ–¹ã«ã‚ˆãè¦‹ã‹ã‘ã‚‹ã€‚äººæ‡ã£ã“ã„ãŒè§¦ã‚‰ã›ã¦ã¯ãã‚Œãªã„çµ¶å¦™ãªè·é›¢æ„Ÿã€‚" },
        { name: "ã‚¹ãƒ¼ãƒ‘ãƒ¼ãŠãŠãŸã‹ã‚„ã®çœ‹æ¿çŒ«", latlng: [35.73690, 139.83675], tags: ["çŒ«"], icon: "çŒ«", image: "images/marker_cat.png", description: "ç™½é»’ã®ãƒãƒãƒ¯ãƒ¬ã€‚åº—ä¸»ã•ã‚“ã«å¯æ„›ãŒã‚‰ã‚Œã¦ã„ã‚‹ã€‚é‹ãŒè‰¯ã‘ã‚Œã°ä¼šãˆã‚‹ã‹ã‚‚ã€‚" },
        { name: "ãƒ¬ãƒˆãƒ­ãªè–¬å±€ã®çœ‹æ¿", latlng: [35.73550, 139.83700], tags: ["çœ‹æ¿"], icon: "çœ‹æ¿", image: "images/marker_signboard.png", description: "ä»Šã§ã¯è¦‹ã‹ã‘ãªã„æ˜”ãªãŒã‚‰ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒæã‹ã‚Œã¦ã„ã‚‹ã€‚å­—ä½“ã‚‚ã‹ã‚ã„ã„ã€‚" },
        { name: "æ‰‹æ›¸ãã®ãƒ©ãƒ¼ãƒ¡ãƒ³å±‹çœ‹æ¿", latlng: [35.73800, 139.83800], tags: ["çœ‹æ¿"], icon: "çœ‹æ¿", image: "images/marker_signboard.png", description: "åº—ä¸»ã®é­‚ãŒã“ã‚‚ã£ãŸæ‰‹æ›¸ãã®çœ‹æ¿ã€‚èª­ã‚€ã ã‘ã§ãŠè…¹ãŒã™ã„ã¦ãã‚‹ã€‚" },
        { name: "å‡ºæ±ã®è‡ªå‹•è²©å£²æ©Ÿ", latlng: [35.73910, 139.83250], tags: ["è‡ªè²©æ©Ÿ"], icon: "è‡ªè²©æ©Ÿ", image: "images/marker_jihanki.png", description: "ãªãœã‹ã“ã“ã«æœ¬æ ¼çš„ãªå‡ºæ±ã®è‡ªè²©æ©ŸãŒã‚ã‚‹ã€‚é‹ã®å­£ç¯€ã«ã¯é‡å®ã™ã‚‹ã‹ã‚‚ï¼Ÿ" }
      ];

      const icons = { 
       'é£²é£Ÿåº—': L.icon({ iconUrl: 'images/marker_restaurant.png', iconSize: [60, 60], iconAnchor: [30,60] }),
       'å…¬åœ’': L.icon({ iconUrl: 'images/marker_park.png', iconSize: [60, 60], iconAnchor: [30,60] }),
       'ã‚¹ãƒ¼ãƒ‘ãƒ¼': L.icon({ iconUrl: 'images/marker_supare.png', iconSize: [60, 60], iconAnchor: [30,60] }), 
       'ã‚­ãƒ£ãƒ—ãƒ†ãƒ³ç¿¼': L.icon({ iconUrl: 'images/kari.png', iconSize: [60, 60], iconAnchor: [30,60] }), 
       'åŒºç«‹æ–½è¨­': L.icon({ iconUrl: 'images/marker_shisetu.png', iconSize: [60, 60], iconAnchor: [30,60] }), 
       'ãã®ä»–': L.icon({ iconUrl: 'images/marker_sonota.png', iconSize: [60, 60], iconAnchor: [30,60] }), 
       'hinann': L.icon({ iconUrl: 'images/kari.png', iconSize: [40, 40], iconAnchor: [30,60] }),
       'itizihinann': L.icon({ iconUrl: 'images/marker_disaster.png', iconSize: [40, 40], iconAnchor: [30,60] }), 
       'shiteihinann': L.icon({ iconUrl: 'images/marker_shelter.png', iconSize: [40, 40], iconAnchor: [30,60] }), 
       'kouzui': L.icon({ iconUrl: 'images/marker_flood.png', iconSize: [40, 40], iconAnchor: [30,60] }), 
       'saigaizikyuu': L.icon({ iconUrl: 'images/marker_drinkingwater.png', iconSize: [40, 40], iconAnchor: [30,60] }), 
       'byouinn': L.icon({ iconUrl: 'images/marker_hospital.png', iconSize: [40, 40], iconAnchor: [30,60] }),
       // â˜…â˜…â˜… é¢ç™½ãƒãƒƒãƒ—ç”¨ã®ã‚¢ã‚¤ã‚³ãƒ³ã‚’çµµæ–‡å­—(L.divIcon)ã«å¤‰æ›´ â˜…â˜…â˜…
       'çŒ«': L.divIcon({ html: 'ğŸˆ', className: 'emoji-marker', iconSize: [40, 40], iconAnchor: [20, 40] }),
       'çœ‹æ¿': L.divIcon({ html: 'ğŸ“œ', className: 'emoji-marker', iconSize: [40, 40], iconAnchor: [20, 40] }),
       'è‡ªè²©æ©Ÿ': L.divIcon({ html: 'ğŸ¥«', className: 'emoji-marker', iconSize: [40, 40], iconAnchor: [20, 40] }),
       'æ™¯è‰²': L.divIcon({ html: 'ğŸï¸', className: 'emoji-marker', iconSize: [40, 40], iconAnchor: [20, 40] }),
       'ãŠèŠ±': L.divIcon({ html: 'ğŸŒ¸', className: 'emoji-marker', iconSize: [40, 40], iconAnchor: [20, 40] })
      };
      
      const places = [ 
        { name: "ã‚«ãƒ•ã‚§ãƒ»ãƒ‰ãƒ»ã‚¯ãƒªã‚¨", latlng: [35.73752, 139.83852], tags: ["é£²é£Ÿåº—"], icon: "é£²é£Ÿåº—", image: "images/crea.png", description: "ã‚«ãƒ•ã‚§ãƒ»ãƒ‰ãƒ»ã‚¯ãƒªã‚¨ã§ã™ã€‚" }, 
        { name: "ãŸã“ç„¼ãæœ¬èˆ—", latlng: [35.73522, 139.83712], tags: ["é£²é£Ÿåº—"], icon: "é£²é£Ÿåº—", image: "images/takoyaki.png", description: "ãŸã“ç„¼ããŒè‡ªæ…¢ã®ãŠåº—ã€‚" }, 
        { name: "å››ã¤æœ¨å…¬åœ’", latlng: [35.733753950986156, 139.83635777333907], tags: ["å…¬åœ’"], icon: "å…¬åœ’", image: "images/kouenn.png", description: "å››ã¤æœ¨ã®ä¸­ã§ã¯ä¸€ç•ªåºƒã„å…¬åœ’ã§ã™ã€‚éŠå…·ã‚‚å¤šãã€å¤§ããªæ»‘ã‚Šå°ãŒç‰¹å¾´çš„ã§ã™ã€‚" },  
        { name: "ç¯ åŸå…¬åœ’", latlng: [35.73795527486445, 139.83415860655035], tags: ["å…¬åœ’"], icon: "å…¬åœ’", image: "images/shino.png", description: "å­ä¾›ãŸã¡ã«äººæ°—ã®å…¬åœ’ã€‚" },
        { name: "å››ã¤æœ¨3ä¸ç›®å…ç«¥éŠåœ’", latlng: [35.73760, 139.83170], tags: ["å…¬åœ’"], icon: "å…¬åœ’", image: "images/koutoudanchi.png", description: "å­ä¾›ãŸã¡ã«äººæ°—ã®å…¬åœ’ã€‚" }, 
        { name: "å››ã¤æœ¨ãƒ¡ãƒ€ã‚«ã®å°é“", latlng: [35.73760, 139.83170], tags: ["å…¬åœ’","ãŠæ•£æ­©"], icon: "å…¬åœ’", image: "images/medakanokomiti.png", description: "å¤ã«ã¯å­ä¾›ãŸã¡ãŒã‚¶ãƒªã‚¬ãƒ‹é‡£ã‚Šã‚’ã—ã¦ã„ã¾ã™ã€‚" }, 
        { name: "æ›³èˆŸå·è¦ªæ°´å…¬åœ’", latlng: [35.741185121020585, 139.83835555737366], tags: ["å…¬åœ’","ãŠæ•£æ­©"], icon: "å…¬åœ’", image: "images/shinn.png", description: "å¤ã«ã¯æ°´ãŒå¼•ã‹ã‚Œã€è‡ªç„¶è±Šã‹ãªå…¬åœ’ã§ã™ã€‚" },
        { name: "ç™½é«­ç¥ç¤¾å…ç«¥éŠåœ’", latlng: [35.737697002024966, 139.8375501257051], tags: ["å…¬åœ’","ç¥ç¤¾"], icon: "å…¬åœ’", image: "images/shinn.png", description: "ç™½é«­ç¥ç¤¾ã«éš£æ¥ã™ã‚‹å…¬åœ’ã§ã™ã€‚ã‚·ãƒ³ãƒ—ãƒ«ãªæ˜”ãªãŒã‚‰ã®éŠå…·ãŒã‚ã‚Šã¾ã™ã€‚" },
        { name: "ã‚ªãƒ¼ã‚±ãƒ¼å››ãƒ„æœ¨åº—", latlng: [35.73807, 139.83162], tags: ["ã‚¹ãƒ¼ãƒ‘ãƒ¼"], icon: "ã‚¹ãƒ¼ãƒ‘ãƒ¼", image: "images/supare.png", description: "é§è»Šå ´ãŒå¤§ããæ¯”è¼ƒçš„ã«å¤§ããªã‚¹ãƒ¼ãƒ‘ãƒ¼ã§ã™ã€‚" },
        { name: "ã‚¹ãƒ¼ãƒ‘ãƒ¼ãŠãŠãŸã‹ã‚„", latlng: [35.73688, 139.83672], tags: ["ã‚¹ãƒ¼ãƒ‘ãƒ¼"], icon: "ã‚¹ãƒ¼ãƒ‘ãƒ¼", image: "images/supare.png", description: "åœ°åŸŸå¯†ç€ã‚¹ãƒ¼ãƒ‘ãƒ¼ã§ã™ã€‚" },
        { name: "ã‚­ãƒ£ãƒ—ãƒ†ãƒ³ç¿¼åƒ", latlng: [35.73778, 139.83912], tags: ["ã‚­ãƒ£ãƒ—ãƒ†ãƒ³ç¿¼"], icon: "ã‚­ãƒ£ãƒ—ãƒ†ãƒ³ç¿¼", image: "images/crot.png", description: "ã‚­ãƒ£ãƒ—ãƒ†ãƒ³ç¿¼ã®éŠ…åƒã§ã™ã€‚" },
        { name: "å››ã¤æœ¨åœ°åŒºã‚»ãƒ³ã‚¿ãƒ¼", latlng: [35.74086, 139.83705], tags: ["åŒºç«‹æ–½è¨­"], icon: "åŒºç«‹æ–½è¨­", image: "images/library.png", description: "åœ°åŸŸã®æ´»å‹•æ‹ ç‚¹ã§ã™ã€‚" }, 
        { name: "è‘›é£¾å››ã¤æœ¨åœ°åŒºå›³æ›¸é¤¨", latlng: [35.737229389659426, 139.83446640003285], tags: ["åŒºç«‹æ–½è¨­"], icon: "åŒºç«‹æ–½è¨­", image: "images/library.png", description: "å…¨å›½ã§ã‚‚çã—ã„å°å­¦æ ¡ã¨ã¤ãªãŒã£ã¦ã„ã‚‹å›³æ›¸é¤¨ã§ã™ã€‚" }, 
        { name: "è¥¿å›³æ›¸é¤¨", latlng: [35.73488, 139.83785], tags: ["ãã®ä»–"], icon: "ãã®ä»–", image: "images/library.png", description: "åŒºç«‹ã®å›³æ›¸é¤¨ã§ã™ã€‚" }, 
        { name: "è¥¿å…‰å¯º", latlng: [35.734467566784, 139.83403555085036], tags: ["ãã®ä»–","å¤©å°å®—"], icon: "ãã®ä»–", image: "images/library.png", description: "å¤©å°å®—ã®ãŠå¯ºã§ã™ã€‚ã€Œä¸€éš…ã‚’ã¦ã‚‰ã™ã€" },
      ];
      
      const disasterPlaces = [ 
        { name: "ã‚ˆã¤ãå°å­¦æ ¡", latlng: [35.73697715826941, 139.83395722617658], tags: ["æŒ‡å®šé¿é›£æ‰€", "ä¸€æ™‚é›†åˆå ´æ‰€", "ç½å®³æ™‚çµ¦æ°´ã‚¹ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³","æ´ªæ°´ç·Šæ€¥é¿é›£å»ºç‰©","AED"], icon: "hinann", image: "images/ojimasyo.png", description: "æŒ‡å®šé¿é›£æ‰€ï¼ˆåŒºç«‹å­¦æ ¡ï¼‰" }, 
        { name: "ã‚ˆã¤ãä¸­å­¦æ ¡", latlng: [35.739043275002764, 139.83496832266331], tags: ["æŒ‡å®šé¿é›£æ‰€", "ä¸€æ™‚é›†åˆå ´æ‰€", "ç½å®³æ™‚çµ¦æ°´ã‚¹ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³","æ´ªæ°´ç·Šæ€¥é¿é›£å»ºç‰©","AED"], icon: "itizihinann", image: "images/ojinishi.png", description: "æŒ‡å®šé¿é›£æ‰€ï¼ˆåŒºç«‹å­¦æ ¡ï¼‰" }, 
        { name: "å¤§é“ä¸­å­¦æ ¡", latlng: [35.744285584956614, 139.84287547484058], tags: ["æŒ‡å®šé¿é›£æ‰€", "ç½å®³æ™‚çµ¦æ°´ã‚¹ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³","æ´ªæ°´ç·Šæ€¥é¿é›£å»ºç‰©","AED"], icon: "saigaizikyuu", image: "images/water_station.png", description: "ç½å®³æ™‚ã«é£²æ–™æ°´ã‚’æä¾›ã—ã¾ã™ã€‚" }, 
        { name: "ç½å®³æ‹ ç‚¹ç—…é™¢", latlng: [35.7375, 139.8362], tags: ["ç½å®³æ‹ ç‚¹ç—…é™¢ãƒ»ç½å®³æ‹ ç‚¹é€£æºç—…é™¢"], icon: "byouinn", image: "images/koutokuyakusyo.png", description: "ç½å®³æ™‚ã®åŒ»ç™‚æ‹ ç‚¹ã¨ãªã‚‹ç—…é™¢ã§ã™ã€‚" } 
      ];

      const categoryTagMap = { 
        hinan: ["ä¸€æ™‚é›†åˆå ´æ‰€", "æŒ‡å®šé¿é›£æ‰€", "é¿é›£å ´æ‰€", "æ´ªæ°´ç·Šæ€¥é¿é›£å»ºç‰©", "å…¬åœ’ãƒ»å…ç«¥éŠåœ’"],
        shienn: ["ç½å®³æ™‚çµ¦æ°´ã‚¹ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³", "åœŸã®ã†ã‚¹ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³", "é˜²ç«è²¯æ°´æ§½", "æ¶ˆç«æ “", "è¡—è·¯æ¶ˆç«å™¨", "ç½å®³æ™‚å”åŠ›äº•æˆ¸"],
        mfd: ["ç·Šæ€¥åŒ»ç™‚æ•‘è­·æ‰€", "ç½å®³æ‹ ç‚¹ç—…é™¢ãƒ»ç½å®³æ‹ ç‚¹é€£æºç—…é™¢", "é˜²ç½æ´»å‹•æ‹ ç‚¹", "è‡ªæ²»ç”ºä¼šæœ¬éƒ¨", "æ¶ˆé˜²å›£ã®è³‡æ©Ÿæå€‰åº«", "å¸‚æ°‘é˜²ç½çµ„ç¹”é˜²ç½å€‰åº«", "AED", "æ¶ˆé˜²ç½²ãƒ»å‡ºå¼µæ‰€", "è­¦å¯Ÿç½²ãƒ»äº¤ç•ª"],
        of: ["å…¬è¡†æµ´å ´", "éƒµä¾¿å±€", "å¹¼ç¨šåœ’", "ä¿è‚²åœ’"] 
      };
      
      // --- DOMè¦ç´ ã®å–å¾— ---
      const placeList = document.getElementById('place-list');
      const searchInput = document.getElementById('search-input');
      const tsujouModeBtn = document.getElementById('tsujou-mode-btn');
      const disasterModeBtn = document.getElementById('disaster-mode-btn');
      const uniqueModeBtn = document.getElementById('unique-mode-btn');
      const clearAllBtn = document.getElementById('clear-all-btn');
      const sidebarToggle = document.getElementById('sidebar-toggle');
      const tsujouTagsDiv = document.getElementById('tsujou-tags');
      const disasterTagsDiv = document.getElementById('disaster-tags');
      const uniqueTagsDiv = document.getElementById('unique-tags');
      const disasterSubTagsContainer = document.getElementById('disaster-sub-tags');
      
      // --- çŠ¶æ…‹ç®¡ç†å¤‰æ•° ---
      let currentMode = null;
      let selectedTags = new Set();
      let markers = [];
      let openCategories = new Set();

      // --- é–¢æ•°å®šç¾© ---
      function switchMode(mode) {
        if (currentMode === mode) return;
        currentMode = mode;
        selectedTags.clear();
        searchInput.value = '';
        openCategories.clear();

        tsujouTagsDiv.style.display = (mode === 'tsujou') ? 'flex' : 'none';
        disasterTagsDiv.style.display = (mode === 'disaster') ? 'flex' : 'none';
        uniqueTagsDiv.style.display = (mode === 'unique') ? 'flex' : 'none';
        
        updateView();
      }
      
      function handleTagClick(event) {
        const tagType = event.target.dataset.type;
        selectedTags.has(tagType) ? selectedTags.delete(tagType) : selectedTags.add(tagType);
        updateView();
      }

      function handleDisasterCategoryClick(event) { const group = event.target.dataset.group; openCategories.has(group) ? openCategories.delete(group) : openCategories.add(group); updateButtonsState(); }
      function handleSubTagClick(event) { const tagType = event.target.dataset.type; selectedTags.has(tagType) ? selectedTags.delete(tagType) : selectedTags.add(tagType); updateView(); }
      function createSubTagButtons() { disasterSubTagsContainer.innerHTML = ''; for (const group in categoryTagMap) { categoryTagMap[group].forEach(tagName => { const btn = document.createElement('button'); btn.className = 'sub-tag-btn'; btn.dataset.type = tagName; btn.dataset.group = group; btn.textContent = tagName; btn.style.display = 'none'; btn.addEventListener('click', handleSubTagClick); disasterSubTagsContainer.appendChild(btn); }); } }
      function updateView() { updateMarkersAndList(); updateButtonsState(); }

      function updateMarkersAndList() {
        markers.forEach(marker => map.removeLayer(marker));
        markers = [];
        placeList.innerHTML = '';
        const searchWord = searchInput.value.trim().toLowerCase();
        
        let data;
        if (currentMode === 'tsujou') data = places;
        else if (currentMode === 'disaster') data = disasterPlaces;
        else if (currentMode === 'unique') data = uniquePlaces;
        else return;

        const filtered = data.filter(place => 
            (selectedTags.size === 0 || place.tags.some(tag => selectedTags.has(tag))) &&
            (place.name.toLowerCase().includes(searchWord) || place.tags.some(tag => tag.toLowerCase().includes(searchWord)))
        );

        filtered.forEach(place => {
          const icon = icons[place.icon] || icons['ãã®ä»–'];
          const marker = L.marker(place.latlng, { icon: icon }).addTo(map);
          marker.bindPopup(place.name, { offset: L.point(0, -30), className: 'custom-popup' }); // offsetèª¿æ•´
          marker.on('click', () => highlightPlaceCard(place.name));
          markers.push(marker);

          const card = document.createElement('div');
          card.classList.add('place-card');
          card.dataset.name = place.name;
          card.innerHTML = `<img src="${place.image || ''}" alt="${place.name}" style="${!place.image ? 'display:none;' : ''}" /><h3>${place.name}</h3><p>${place.description}</p><div class="place-tags">${place.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}</div>`;

          card.addEventListener('click', () => {
            map.panTo(place.latlng);
            marker.openPopup();
            highlightPlaceCard(place.name);
          });
          placeList.appendChild(card);
        });
      }

      function updateButtonsState() {
        tsujouModeBtn.classList.toggle('active', currentMode === 'tsujou');
        disasterModeBtn.classList.toggle('active', currentMode === 'disaster');
        uniqueModeBtn.classList.toggle('active', currentMode === 'unique');
        
        clearAllBtn.disabled = selectedTags.size === 0 && searchInput.value.trim() === '';

        document.querySelectorAll('#tsujou-tags .tag-btn, #unique-tags .tag-btn').forEach(btn => {
            btn.classList.toggle('active', selectedTags.has(btn.dataset.type));
        });
        
        document.querySelectorAll('.disaster-category-btn').forEach(btn => { const group = btn.dataset.group; btn.classList.toggle('is-open', openCategories.has(group)); const hasSelection = (categoryTagMap[group] || []).some(tag => selectedTags.has(tag)); btn.classList.toggle('contains-selection', hasSelection); });
        disasterSubTagsContainer.classList.toggle('show', openCategories.size > 0);
        document.querySelectorAll('.sub-tag-btn').forEach(btn => { btn.style.display = openCategories.has(btn.dataset.group) ? 'inline-block' : 'none'; btn.classList.toggle('active', selectedTags.has(btn.dataset.type)); });
      }
      function highlightPlaceCard(name) {
        document.querySelectorAll('.place-card').forEach(card => {
          const isMatch = card.dataset.name === name;
          card.classList.toggle('highlight', isMatch);
          if (isMatch) {
            card.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
        });
      }
      
      // --- åˆæœŸåŒ–å‡¦ç† ---
      map.fitBounds(yotsugiBounds);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OpenStreetMap contributors' }).addTo(map);
      
      const imageUrl = 'images/6-11-23-41.png';
      const scale = 1.79, latCenter = 35.738, lngCenter = 139.83559;
      const latHeight = 0.00883 * scale, lngWidth = latHeight * 1.208;
      const imageBounds = [[latCenter - latHeight / 2, lngCenter - lngWidth / 2], [latCenter + latHeight / 2, lngCenter + lngWidth / 2]];
      L.imageOverlay(imageUrl, imageBounds).addTo(map);

      // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š ---
      sidebarToggle.addEventListener('click', () => { document.body.classList.toggle('sidebar-collapsed'); setTimeout(() => map.invalidateSize(), 300); });
      clearAllBtn.addEventListener('click', () => {
        selectedTags.clear();
        openCategories.clear();
        searchInput.value = '';
        updateView();
      });
      tsujouModeBtn.addEventListener('click', () => switchMode('tsujou'));
      disasterModeBtn.addEventListener('click', () => switchMode('disaster'));
      uniqueModeBtn.addEventListener('click', () => switchMode('unique'));
      
      searchInput.addEventListener('input', updateView);
      
      document.querySelectorAll('#tsujou-tags .tag-btn').forEach(btn => btn.addEventListener('click', handleTagClick));
      document.querySelectorAll('#unique-tags .tag-btn').forEach(btn => btn.addEventListener('click', handleTagClick));
      document.querySelectorAll('.disaster-category-btn').forEach(btn => btn.addEventListener('click', handleDisasterCategoryClick));
      
      createSubTagButtons();
      // disaster-sub-tagså†…ã®ãƒœã‚¿ãƒ³ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
      disasterSubTagsContainer.addEventListener('click', (event) => {
        if (event.target.classList.contains('sub-tag-btn')) {
            handleSubTagClick(event);
        }
      });
      
      switchMode('tsujou');
    });
  </script>
</body>
</html>
